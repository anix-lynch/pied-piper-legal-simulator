<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üßæ Pied Piper Legal Simulator</title>
    <meta name="description" content="Interactive VC negotiation simulator - Learn term-sheet dynamics through Silicon Valley scenarios">
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'google': ['Google Sans', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                    },
                    colors: {
                        'hooli-blue': '#1a73e8',
                        'hooli-blue-dark': '#1557b0',
                        'hooli-gray': '#f8f9fa',
                        'hooli-gray-light': '#f1f3f4',
                        'hooli-text': '#202124',
                        'hooli-text-secondary': '#5f6368',
                        'hooli-border': '#e8eaed',
                        'hooli-surface': '#ffffff',
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .material-shadow {
            box-shadow: 0 1px 3px 0 rgba(60, 64, 67, 0.302), 0 4px 8px 3px rgba(60, 64, 67, 0.149);
        }
        .material-shadow-lg {
            box-shadow: 0 8px 25px -8px rgba(0, 0, 0, 0.2), 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        }
        .material-card {
            background: white;
            border-radius: 8px;
            border: 1px solid #e8eaed;
        }
        .material-button {
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .material-button:hover {
            background: #1557b0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        .material-button-secondary {
            background: #f8f9fa;
            color: #3c4043;
            border: 1px solid #dadce0;
        }
        .material-button-secondary:hover {
            background: #f1f3f4;
        }
        .progress-bar {
            background: #e8eaed;
            border-radius: 4px;
            height: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .vc-progress { background: #ea4335; }
        .founder-progress { background: #34a853; }
        .balance-progress { background: #fbbc04; }
    </style>
</head>
<body class="bg-hooli-gray font-google text-hooli-text min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [episodes, setEpisodes] = useState([]);
            const [selectedEpisode, setSelectedEpisode] = useState(null);
            const [simulation, setSimulation] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            const API_BASE = "https://pied-piper-legal-simulator-anix-lynchs-projects.vercel.app";

            useEffect(() => {
                fetchEpisodes();
            }, []);

            const fetchEpisodes = async () => {
                try {
                    const res = await fetch(`${API_BASE}/episodes`);
                    const data = await res.json();
                    setEpisodes(data.episodes);
                    if (data.episodes.length > 0) {
                        setSelectedEpisode(data.episodes[0].episode_id);
                    }
                } catch (err) {
                    setError("Failed to load episodes. API may be initializing...");
                }
            };

            const runSimulation = async () => {
                if (!selectedEpisode) return;
                
                setLoading(true);
                setError(null);
                
                try {
                    const res = await fetch(`${API_BASE}/simulate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            episode_id: selectedEpisode,
                            mode: 'all'
                        })
                    });
                    
                    const data = await res.json();
                    setSimulation(data);
                } catch (err) {
                    setError("Simulation failed. Check console for details.");
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            };

            const exportMarkdown = async () => {
                if (!selectedEpisode) return;
                
                try {
                    const res = await fetch(`${API_BASE}/export/${selectedEpisode}`);
                    const data = await res.json();
                    
                    // Download as file
                    const blob = new Blob([data.markdown], { type: 'text/markdown' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `pied-piper-${selectedEpisode}.md`;
                    a.click();
                } catch (err) {
                    console.error("Export failed:", err);
                }
            };

            const ScenarioCard = ({ title, icon, color, data, scores }) => (
                <div className={`material-card material-shadow border-2 ${color}`}>
                    <div className="p-6 border-b border-hooli-border">
                        <div className="flex items-center gap-3 mb-4">
                            <div className="w-10 h-10 bg-hooli-gray-light rounded-lg flex items-center justify-center">
                                <span className="text-xl">{icon}</span>
                            </div>
                            <div>
                                <h3 className="text-xl font-google font-medium text-hooli-text">{title}</h3>
                                <p className="text-sm text-hooli-text-secondary">
                                    {title === 'VC Win' ? 'Investor-favorable terms' :
                                     title === 'Founder Win' ? 'Founder-favorable terms' :
                                     'Balanced partnership terms'}
                                </p>
                            </div>
                        </div>

                        {/* Alignment Scores */}
                        <div className="space-y-3">
                            <div>
                                <div className="flex items-center justify-between mb-1">
                                    <span className="text-sm font-google text-hooli-text-secondary">VC Alignment</span>
                                    <span className="font-google font-medium text-hooli-text">{scores.vc}%</span>
                                </div>
                                <div className="progress-bar">
                                    <div className="progress-fill vc-progress" style={{width: `${scores.vc}%`}}></div>
                                </div>
                            </div>

                            <div>
                                <div className="flex items-center justify-between mb-1">
                                    <span className="text-sm font-google text-hooli-text-secondary">Founder Alignment</span>
                                    <span className="font-google font-medium text-hooli-text">{scores.founder}%</span>
                                </div>
                                <div className="progress-bar">
                                    <div className="progress-fill founder-progress" style={{width: `${scores.founder}%`}}></div>
                                </div>
                            </div>

                            <div>
                                <div className="flex items-center justify-between mb-1">
                                    <span className="text-sm font-google text-hooli-text-secondary">Balance Score</span>
                                    <span className="font-google font-medium text-hooli-text">{scores.balance}%</span>
                                </div>
                                <div className="progress-bar">
                                    <div className="progress-fill balance-progress" style={{width: `${scores.balance}%`}}></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="p-6">
                        {data.clauses.length > 0 ? (
                            <>
                                <p className="text-hooli-text-secondary text-sm mb-4 leading-relaxed">{data.narrative}</p>
                                <div className="space-y-3">
                                    {data.clauses.map((clause, idx) => (
                                        <div key={idx} className="p-3 bg-hooli-gray-light rounded-lg">
                                            <div className="font-google font-medium text-hooli-text text-sm mb-1">
                                                {clause.clause_type || clause.short_text || clause}
                                            </div>
                                            {clause.short_text && clause.clause_type && (
                                                <div className="text-xs text-hooli-text-secondary mt-1">
                                                    {clause.short_text}
                                                </div>
                                            )}
                                            {clause.explanation && (
                                                <div className="text-xs text-hooli-text-secondary mt-2 italic">
                                                    {clause.explanation}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </>
                        ) : (
                            <div className="text-center py-8">
                                <div className="w-12 h-12 bg-hooli-gray-light rounded-full flex items-center justify-center mx-auto mb-3">
                                    <span className="text-hooli-text-secondary">üìÑ</span>
                                </div>
                                <p className="text-hooli-text-secondary text-sm">No clauses available for this scenario</p>
                            </div>
                        )}
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-hooli-gray">
                    <div className="max-w-7xl mx-auto px-6 py-8">
                        {/* Header */}
                        <div className="text-center mb-12">
                            <div className="flex items-center justify-center gap-3 mb-4">
                                <div className="w-12 h-12 bg-hooli-blue rounded-lg flex items-center justify-center">
                                    <span className="text-white text-xl">üßæ</span>
                                </div>
                                <div>
                                    <h1 className="text-3xl font-google font-medium text-hooli-text">Pied Piper Legal Simulator</h1>
                                    <p className="text-hooli-text-secondary text-sm">Interactive VC negotiation simulator ‚Ä¢ Silicon Valley scenarios</p>
                                </div>
                            </div>
                            <p className="text-sm text-hooli-text-secondary mt-2">
                                Built by <a href="https://gozeroshot.dev" className="text-hooli-blue hover:underline">Anix Lynch</a> ‚Ä¢
                                AI-powered legal analysis with 3 negotiation outcomes
                            </p>
                        </div>

                        {/* Controls */}
                        <div className="material-card material-shadow p-6 mb-8">
                            <div className="flex flex-col md:flex-row gap-4 items-center">
                                <div className="flex-1">
                                    <label className="block font-google font-medium text-hooli-text mb-2 text-sm">Select Episode:</label>
                                    <select
                                        className="w-full bg-hooli-surface border border-hooli-border rounded-lg px-4 py-3 text-hooli-text focus:ring-2 focus:ring-hooli-blue focus:border-transparent"
                                        value={selectedEpisode || ''}
                                        onChange={(e) => setSelectedEpisode(e.target.value)}
                                    >
                                        {episodes.map(ep => (
                                            <option key={ep.episode_id} value={ep.episode_id}>
                                                {ep.episode_id}: {ep.title}
                                            </option>
                                        ))}
                                    </select>
                                </div>

                                <div className="flex gap-3">
                                    <button
                                        onClick={runSimulation}
                                        disabled={loading}
                                        className={`material-button ${loading ? 'opacity-50 cursor-not-allowed' : ''}`}
                                    >
                                        {loading ? (
                                            <span className="flex items-center gap-2">
                                                <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                                Generating...
                                            </span>
                                        ) : (
                                            'üöÄ Generate'
                                        )}
                                    </button>

                                    <button
                                        onClick={exportMarkdown}
                                        disabled={!simulation}
                                        className="material-button-secondary"
                                    >
                                        üìÑ Export
                                    </button>
                                </div>
                            </div>

                            {error && (
                                <div className="mt-6 material-card border-red-200 bg-red-50 p-4">
                                    <div className="flex items-center gap-3">
                                        <div className="w-5 h-5 text-red-500">‚ö†Ô∏è</div>
                                        <p className="text-red-700">{error}</p>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Episode Info */}
                        {simulation && (
                            <div className="material-card material-shadow p-6 mb-8">
                                <h2 className="text-2xl font-google font-medium text-hooli-text mb-6">
                                    {simulation.episode.title} <span className="text-hooli-text-secondary">({simulation.episode.episode_id})</span>
                                </h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <h3 className="font-google font-medium text-hooli-blue mb-2">Conflict Type</h3>
                                        <p className="text-hooli-text-secondary">{simulation.episode.conflict_type}</p>
                                    </div>
                                    <div>
                                        <h3 className="font-google font-medium text-hooli-blue mb-2">Legal Stakes</h3>
                                        <p className="text-hooli-text-secondary">{simulation.episode.legal_stakes}</p>
                                    </div>
                                    <div className="md:col-span-2">
                                        <h3 className="font-google font-medium text-hooli-blue mb-2">Scene</h3>
                                        <p className="text-hooli-text-secondary">{simulation.episode.scene}</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Three Scenarios */}
                        {simulation && (
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <ScenarioCard
                                    title="VC Win"
                                    icon="üí∞"
                                    color="bg-gradient-to-br from-red-50 to-red-100 border-red-200"
                                    data={simulation.scenarios.vc_win}
                                    scores={simulation.alignment_scores.vc_win}
                                />

                                <ScenarioCard
                                    title="Founder Win"
                                    icon="üí°"
                                    color="bg-gradient-to-br from-green-50 to-green-100 border-green-200"
                                    data={simulation.scenarios.founder_win}
                                    scores={simulation.alignment_scores.founder_win}
                                />

                                <ScenarioCard
                                    title="Win-Win"
                                    icon="ü§ù"
                                    color="bg-gradient-to-br from-yellow-50 to-yellow-100 border-yellow-200"
                                    data={simulation.scenarios.winwin}
                                    scores={simulation.alignment_scores.winwin}
                                />
                            </div>
                        )}

                        {!simulation && !loading && (
                            <div className="text-center py-16">
                                <div className="material-card material-shadow p-8 max-w-md mx-auto">
                                    <div className="w-16 h-16 bg-hooli-gray-light rounded-full flex items-center justify-center mx-auto mb-4">
                                        <span className="text-2xl">üéØ</span>
                                    </div>
                                    <h3 className="font-google font-medium text-hooli-text mb-2">Ready to Simulate</h3>
                                    <p className="text-hooli-text-secondary text-sm">Select an episode and click "Generate" to see 3 negotiation outcomes</p>
                                </div>
                            </div>
                        )}

                        {/* Pied Piper Context Section */}
                        {simulation && (
                            <div className="mt-16 mb-8">
                                <div className="material-card material-shadow p-8">
                                    <div className="text-center mb-8">
                                        <div className="w-16 h-16 bg-gradient-to-br from-blue-100 to-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <span className="text-3xl">üé≠</span>
                                        </div>
                                        <h2 className="text-2xl font-google font-medium text-hooli-text mb-2">What Happened in "{simulation.episode.title}"? ü§î</h2>
                                        <p className="text-hooli-text-secondary">{simulation.episode.scene}</p>
                                    </div>

                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                    {/* VC Win Drama */}
                                    <div className="text-center">
                                        <div className="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center mx-auto mb-3">
                                            <span className="text-red-600 text-xl">üí∞</span>
                                        </div>
                                        <h3 className="font-google font-medium text-hooli-text mb-3">VC WIN = Investors Take Control ü§ë</h3>
                                        <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-left">
                                            <p className="text-red-800 text-sm mb-2 italic">"{simulation.episode.vc_action}"</p>
                                            <p className="text-red-700 text-sm leading-relaxed">
                                                {simulation.scenarios.vc_win.narrative}
                                            </p>
                                            <div className="mt-3 pt-3 border-t border-red-300">
                                                <p className="text-red-600 text-xs font-medium">Real Stakes:</p>
                                                <p className="text-red-700 text-xs mt-1">{simulation.episode.legal_stakes}</p>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Founder Win Drama */}
                                    <div className="text-center">
                                        <div className="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mx-auto mb-3">
                                            <span className="text-green-600 text-xl">üí°</span>
                                        </div>
                                        <h3 className="font-google font-medium text-hooli-text mb-3">FOUNDER WIN = Founder Keeps Control ‚ú®</h3>
                                        <div className="bg-green-50 border border-green-200 rounded-lg p-4 text-left">
                                            <p className="text-green-800 text-sm mb-2 italic">"{simulation.episode.founder_action}"</p>
                                            <p className="text-green-700 text-sm leading-relaxed">
                                                {simulation.scenarios.founder_win.narrative}
                                            </p>
                                            <div className="mt-3 pt-3 border-t border-green-300">
                                                <p className="text-green-600 text-xs font-medium">What Richard Wanted:</p>
                                                <p className="text-green-700 text-xs mt-1">{simulation.episode.result}</p>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Win-Win Drama */}
                                    <div className="text-center">
                                        <div className="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center mx-auto mb-3">
                                            <span className="text-yellow-600 text-xl">ü§ù</span>
                                        </div>
                                        <h3 className="font-google font-medium text-hooli-text mb-3">WIN-WIN = Balanced Deal ü¶Ñ</h3>
                                        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-left">
                                            <p className="text-yellow-800 text-sm mb-2 italic">"Everyone wins... theoretically"</p>
                                            <p className="text-yellow-700 text-sm leading-relaxed">
                                                {simulation.scenarios.winwin.narrative}
                                            </p>
                                            <div className="mt-3 pt-3 border-t border-yellow-300">
                                                <p className="text-yellow-600 text-xs font-medium">The Conflict:</p>
                                                <p className="text-yellow-700 text-xs mt-1">{simulation.episode.conflict_type.replace(/_/g, ' ').toUpperCase()}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="mt-8 p-6 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border border-blue-200">
                                    <div className="flex items-start gap-4">
                                        <div className="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                                            <span className="text-blue-600">üí°</span>
                                        </div>
                                        <div>
                                            <h4 className="font-google font-medium text-hooli-text mb-2">Episode Context: {simulation.episode.title}</h4>
                                            <p className="text-hooli-text-secondary text-sm leading-relaxed mb-2">
                                                <strong>The Setup:</strong> {simulation.episode.scene}
                                            </p>
                                            <p className="text-hooli-text-secondary text-sm leading-relaxed">
                                                <strong>What Actually Happened:</strong> {simulation.episode.result} This is one of those classic Silicon Valley 
                                                moments where founders and investors have completely different incentives. The clauses above show how the same conflict 
                                                could have played out under different term sheet structures.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

